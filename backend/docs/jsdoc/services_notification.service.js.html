<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/notification.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="EmailError.html">EmailError</a></li><li><a href="HealthService.html">HealthService</a><ul class='methods'><li data-type='method'><a href="HealthService.html#checkAuth">checkAuth</a></li><li data-type='method'><a href="HealthService.html#checkEmail">checkEmail</a></li><li data-type='method'><a href="HealthService.html#checkFirestore">checkFirestore</a></li><li data-type='method'><a href="HealthService.html#checkHealth">checkHealth</a></li><li data-type='method'><a href="HealthService.html#checkScheduler">checkScheduler</a></li><li data-type='method'><a href="HealthService.html#getLastScrapingStatus">getLastScrapingStatus</a></li><li data-type='method'><a href="HealthService.html#getMemoryUsage">getMemoryUsage</a></li><li data-type='method'><a href="HealthService.html#getMetrics">getMetrics</a></li></ul></li><li><a href="NotificationService.html">NotificationService</a><ul class='methods'><li data-type='method'><a href="NotificationService.html#checkAndNotify">checkAndNotify</a></li><li data-type='method'><a href="NotificationService.html#hasSettingNotified">hasSettingNotified</a></li><li data-type='method'><a href="NotificationService.html#matchesCriteria">matchesCriteria</a></li><li data-type='method'><a href="NotificationService.html#sendEmailNotification">sendEmailNotification</a></li><li data-type='method'><a href="NotificationService.html#sendNotifications">sendNotifications</a></li></ul></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ScraperError.html">ScraperError</a></li><li><a href="ScraperService.html">ScraperService</a><ul class='methods'><li data-type='method'><a href="ScraperService.html#parsePage">parsePage</a></li><li data-type='method'><a href="ScraperService.html#scrapeCampingSite">scrapeCampingSite</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ERROR_CODES">ERROR_CODES</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#checkForActiveSettings">checkForActiveSettings</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#executeScraping">executeScraping</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatErrorResponse">formatErrorResponse</a></li><li><a href="global.html#formatYearMonth">formatYearMonth</a></li><li><a href="global.html#getKoreaDate">getKoreaDate</a></li><li><a href="global.html#getKoreaHour">getKoreaHour</a></li><li><a href="global.html#getMonthsFromSettings">getMonthsFromSettings</a></li><li><a href="global.html#getMonthsToScrape">getMonthsToScrape</a></li><li><a href="global.html#getRandomDelay">getRandomDelay</a></li><li><a href="global.html#isOperationalError">isOperationalError</a></li><li><a href="global.html#isRetryableError">isRetryableError</a></li><li><a href="global.html#isSleepTime">isSleepTime</a></li><li><a href="global.html#logRequestMiddleware">logRequestMiddleware</a></li><li><a href="global.html#matchesSetting">matchesSetting</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#retryIfRetryable">retryIfRetryable</a></li><li><a href="global.html#retryStrategies">retryStrategies</a></li><li><a href="global.html#retryWithBackoff">retryWithBackoff</a></li><li><a href="global.html#retryWithFixedDelay">retryWithFixedDelay</a></li><li><a href="global.html#runScrapingNow">runScrapingNow</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#startScheduler">startScheduler</a></li><li><a href="global.html#stopScheduler">stopScheduler</a></li><li><a href="global.html#validateConfig">validateConfig</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/notification.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { sendEmail } from '../config/email.js';
import { logger } from '../utils/logger.js';
import { firestoreService } from './firestore.service.js';
import { retryStrategies } from '../utils/retry.js';

/**
 * ì•Œë¦¼ ì„œë¹„ìŠ¤
 * @class
 * @description ìº í•‘ì¥ ì˜ˆì•½ ê°€ëŠ¥ ì‹œ ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ ì•Œë¦¼ì„ ë°œì†¡í•˜ëŠ” ì„œë¹„ìŠ¤
 */
export class NotificationService {
  /**
   * ìƒˆë¡œìš´ ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©ì„ í™•ì¸í•˜ê³  ì•Œë¦¼ ë°œì†¡
   * @async
   * @param {Array} newAvailability - ìŠ¤í¬ë˜í•‘ëœ ì˜ˆì•½ ê°€ëŠ¥ í˜„í™© ë°°ì—´
   * @returns {Promise&lt;void>}
   * @description
   * - ëª¨ë“  í™œì„± ì‚¬ìš©ì ì„¤ì •ì„ ì¡°íšŒ
   * - ê° ì„¤ì •ì˜ ì¡°ê±´(ìº í•‘ì¥, ì§€ì—­, êµ¬ì—­, ë‚ ì§œ)ê³¼ ë§¤ì¹­
   * - ì¡°ê±´ ì¼ì¹˜ ì‹œ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ë° ì„¤ì • ë¹„í™œì„±í™”
   */
  async checkAndNotify(newAvailability) {
    try {
      logger.info('ğŸ”” Checking for notification triggers...');

      // Get all active user settings
      const activeSettings = await firestoreService.getAllActiveSettings();

      for (const setting of activeSettings) {
        // Check if this availability matches user's criteria
        const matches = this.matchesCriteria(newAvailability, setting);

        if (matches.length > 0) {
          await this.sendNotifications(setting, matches);
        }
      }
    } catch (error) {
      logger.error('Error in checkAndNotify:', error);
      throw error;
    }
  }

  /**
   * ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©ì´ ì‚¬ìš©ì ì„¤ì • ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
   * @param {Array} availabilityList - ì˜ˆì•½ ê°€ëŠ¥ í˜„í™© ëª©ë¡
   * @param {Object} setting - ì‚¬ìš©ì ì„¤ì • ê°ì²´
   * @returns {Array} ì¡°ê±´ì— ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ ê°€ëŠ¥ í•­ëª© ë°°ì—´
   * @description
   * - ìº í•‘ì¥ëª…, ì§€ì—­, êµ¬ì—­(OR ì¡°ê±´), ë‚ ì§œ ë²”ìœ„ í™•ì¸
   * - availableCount > 0ì¸ í•­ëª©ë§Œ ë°˜í™˜
   */
  matchesCriteria(availabilityList, setting) {
    const matches = [];

    for (const item of availabilityList) {
      // Check camping name
      if (setting.campingName &amp;&amp; item.campingName !== setting.campingName) {
        continue;
      }

      // Check region
      if (setting.region &amp;&amp; item.region !== setting.region) {
        continue;
      }

      // Check area (if user specified specific areas)
      if (setting.area &amp;&amp; setting.area.length > 0) {
        if (!setting.area.includes(item.area)) {
          continue;
        }
      }

      // Check date range
      const itemDate = new Date(item.date);
      const dateFrom = setting.dateFrom ? new Date(setting.dateFrom) : null;
      const dateTo = setting.dateTo ? new Date(setting.dateTo) : null;

      if (dateFrom &amp;&amp; itemDate &lt; dateFrom) {
        continue;
      }

      if (dateTo &amp;&amp; itemDate > dateTo) {
        continue;
      }

      // Check if there's availability
      if (item.availableCount > 0) {
        matches.push(item);
      }
    }

    return matches;
  }

  /**
   * ì•Œë¦¼ ë°œì†¡ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
   * @async
   * @param {Object} setting - ì‚¬ìš©ì ì„¤ì • ê°ì²´
   * @param {Array} matches - ì¡°ê±´ì— ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ ê°€ëŠ¥ í•­ëª© ë°°ì—´
   * @returns {Promise&lt;void>}
   * @description
   * - ì´ë¯¸ ì•Œë¦¼ì„ ë°œì†¡í•œ ì„¤ì •ì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
   * - ì²« ë²ˆì§¸ ë§¤ì¹­ í•­ëª©ì— ëŒ€í•´ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
   * - Firestoreì— ì•Œë¦¼ ê¸°ë¡ ì €ì¥
   * - ì•Œë¦¼ ë°œì†¡ í›„ ì„¤ì •ì„ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™” (1íšŒì„± ì•Œë¦¼)
   */
  async sendNotifications(setting, matches) {
    try {
      // Get user info
      const userId = setting.userId;

      // Check if this setting has already triggered a notification
      const hasNotified = await this.hasSettingNotified(setting.id);

      if (hasNotified) {
        logger.info(
          `Setting ${setting.id} has already triggered notification, ensuring it's deactivated`
        );

        // Ensure the setting is deactivated (in case deactivation failed before)
        await firestoreService.updateUserSetting(setting.id, { isActive: false });
        logger.info(`ğŸ”• Setting ${setting.id} deactivated (already notified)`);
        return;
      }

      // Send notification for the first match only (to avoid spam)
      if (matches.length > 0) {
        const match = matches[0]; // Send only for the first available match
        const notificationKey = `${match.campingName}-${match.area}-${match.date}`;

        // Send email notification
        await this.sendEmailNotification(userId, setting, match);

        // TODO: Send push notification if user has pushToken

        // Save notification record
        await firestoreService.saveNotification({
          userId,
          settingId: setting.id,
          campingName: match.campingName,
          area: match.area,
          date: match.date,
          availableCount: match.availableCount,
          notificationType: 'email'
        });

        logger.info(`âœ… Notification sent to user ${userId} for ${notificationKey}`);

        // Deactivate the setting after sending notification
        await firestoreService.updateUserSetting(setting.id, { isActive: false });
        logger.info(`ğŸ”• Setting ${setting.id} deactivated after sending notification`);
      }
    } catch (error) {
      logger.error('Error sending notifications:', error);
      throw error;
    }
  }

  /**
   * ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
   * @async
   * @param {string} userId - ì‚¬ìš©ì ID
   * @param {Object} setting - ì‚¬ìš©ì ì„¤ì • ê°ì²´
   * @param {Object} match - ë§¤ì¹­ëœ ì˜ˆì•½ ê°€ëŠ¥ ì •ë³´
   * @returns {Promise&lt;void>}
   * @throws {Error} ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ ì‹œ
   * @description
   * - Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (notificationEmail ìš°ì„ , ì—†ìœ¼ë©´ email ì‚¬ìš©)
   * - HTML í˜•ì‹ì˜ ì´ë©”ì¼ ìƒì„± (ìº í•‘ì¥ ì •ë³´, ë‚ ì§œ, ì˜ˆì•½ ê°€ëŠ¥ ìˆ˜ í¬í•¨)
   * - Retry ì „ëµì„ ì ìš©í•˜ì—¬ ì´ë©”ì¼ ë°œì†¡
   */
  async sendEmailNotification(userId, setting, match) {
    try {
      // Get user info from Firestore
      const db = firestoreService.getDb();
      const userDoc = await db.collection('users').doc(userId).get();

      let userEmail = 'user@example.com';
      if (userDoc.exists) {
        const userData = userDoc.data();
        // Use notificationEmail if available, otherwise use email
        userEmail = userData.notificationEmail || userData.email;
      }

      if (!userEmail || userEmail === 'user@example.com') {
        logger.warn(`No valid email found for user ${userId}`);
        return;
      }

      const subject = `ğŸ•ï¸ ìº í•‘ì¥ ì˜ˆì•½ ê°€ëŠ¥! - ${match.campingName}`;

      const html = `
        &lt;div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          &lt;h2 style="color: #2ecc71;">ğŸ•ï¸ ìº í•‘ì¥ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!&lt;/h2>

          &lt;div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
            &lt;h3 style="margin-top: 0;">ì˜ˆì•½ ì •ë³´&lt;/h3>
            &lt;p>&lt;strong>ìº í•‘ì¥:&lt;/strong> ${match.campingName}&lt;/p>
            &lt;p>&lt;strong>ì§€ì—­:&lt;/strong> ${match.region}&lt;/p>
            &lt;p>&lt;strong>êµ¬ì—­:&lt;/strong> ${match.area}&lt;/p>
            &lt;p>&lt;strong>ë‚ ì§œ:&lt;/strong> ${match.date}&lt;/p>
            &lt;p>&lt;strong>ì˜ˆì•½ ê°€ëŠ¥ ìˆ˜:&lt;/strong> &lt;span style="color: #e74c3c; font-size: 18px; font-weight: bold;">${match.availableCount}&lt;/span>&lt;/p>
          &lt;/div>

          &lt;p style="color: #e74c3c; font-weight: bold;">âš ï¸ ë¹ ë¥´ê²Œ ì˜ˆì•½í•˜ì„¸ìš”! ìë¦¬ê°€ ê³§ ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/p>

          &lt;div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; font-size: 12px; color: #7f8c8d;">
            &lt;p>ì´ ì•Œë¦¼ì€ íšŒì›ë‹˜ì˜ ì„¤ì •ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/p>
            &lt;p>ì•Œë¦¼ì„ ì¤‘ì§€í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ í•´ë‹¹ ì¡°ê±´ì„ ë¹„í™œì„±í™”í•˜ì„¸ìš”.&lt;/p>
          &lt;/div>
        &lt;/div>
      `;

      // Send email with retry logic
      await retryStrategies.email(() => sendEmail(userEmail, subject, html));
    } catch (error) {
      logger.error('Error sending email notification:', error);
      throw error;
    }
  }

  /**
   * ì„¤ì •ì— ëŒ€í•œ ì•Œë¦¼ ë°œì†¡ ì´ë ¥ í™•ì¸
   * @async
   * @param {string} settingId - ì‚¬ìš©ì ì„¤ì • ID
   * @returns {Promise&lt;boolean>} ì•Œë¦¼ ë°œì†¡ ì´ë ¥ì´ ìˆìœ¼ë©´ true, ì—†ìœ¼ë©´ false
   * @description ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ notifications ì»¬ë ‰ì…˜ì—ì„œ settingIdë¡œ ì¡°íšŒ
   */
  async hasSettingNotified(settingId) {
    try {
      const db = firestoreService.getDb();
      const snapshot = await db
        .collection('notifications')
        .where('settingId', '==', settingId)
        .limit(1)
        .get();

      return !snapshot.empty;
    } catch (error) {
      logger.error('Error checking if setting has notified:', error);
      return false;
    }
  }
}

export const notificationService = new NotificationService();
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
