<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/health.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="EmailError.html">EmailError</a></li><li><a href="HealthService.html">HealthService</a><ul class='methods'><li data-type='method'><a href="HealthService.html#checkAuth">checkAuth</a></li><li data-type='method'><a href="HealthService.html#checkEmail">checkEmail</a></li><li data-type='method'><a href="HealthService.html#checkFirestore">checkFirestore</a></li><li data-type='method'><a href="HealthService.html#checkHealth">checkHealth</a></li><li data-type='method'><a href="HealthService.html#checkScheduler">checkScheduler</a></li><li data-type='method'><a href="HealthService.html#getLastScrapingStatus">getLastScrapingStatus</a></li><li data-type='method'><a href="HealthService.html#getMemoryUsage">getMemoryUsage</a></li><li data-type='method'><a href="HealthService.html#getMetrics">getMetrics</a></li></ul></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ScraperError.html">ScraperError</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ERROR_CODES">ERROR_CODES</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatErrorResponse">formatErrorResponse</a></li><li><a href="global.html#formatYearMonth">formatYearMonth</a></li><li><a href="global.html#getKoreaDate">getKoreaDate</a></li><li><a href="global.html#getKoreaHour">getKoreaHour</a></li><li><a href="global.html#getMonthsFromSettings">getMonthsFromSettings</a></li><li><a href="global.html#getMonthsToScrape">getMonthsToScrape</a></li><li><a href="global.html#getRandomDelay">getRandomDelay</a></li><li><a href="global.html#isOperationalError">isOperationalError</a></li><li><a href="global.html#isRetryableError">isRetryableError</a></li><li><a href="global.html#isSleepTime">isSleepTime</a></li><li><a href="global.html#logRequestMiddleware">logRequestMiddleware</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#retryIfRetryable">retryIfRetryable</a></li><li><a href="global.html#retryStrategies">retryStrategies</a></li><li><a href="global.html#retryWithBackoff">retryWithBackoff</a></li><li><a href="global.html#retryWithFixedDelay">retryWithFixedDelay</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#validateConfig">validateConfig</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/health.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getFirestore, getAuth } from '../config/firebase.js';
import { getEmailTransporter } from '../config/email.js';
import { logger } from '../utils/logger.js';

/**
 * Health Check Service
 */
export class HealthService {
  /**
   * Check overall system health
   */
  async checkHealth() {
    const startTime = Date.now();

    const checks = {
      firestore: await this.checkFirestore(),
      auth: this.checkAuth(),
      email: await this.checkEmail(),
      scheduler: this.checkScheduler()
    };

    const isHealthy = Object.values(checks).every(check => check.status === 'healthy');
    const responseTime = Date.now() - startTime;

    return {
      status: isHealthy ? 'healthy' : 'unhealthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      responseTime,
      checks,
      system: {
        memory: this.getMemoryUsage(),
        cpu: process.cpuUsage()
      }
    };
  }

  /**
   * Check Firestore connection
   */
  async checkFirestore() {
    try {
      const db = getFirestore();
      const testRef = db.collection('_health_check');

      // Try to write a test document
      await testRef.doc('test').set({
        timestamp: new Date(),
        test: true
      });

      // Try to read it back
      await testRef.doc('test').get();

      // Clean up
      await testRef.doc('test').delete();

      return {
        status: 'healthy',
        message: 'Firestore connection OK'
      };
    } catch (error) {
      logger.error('Firestore health check failed', { error: error.message });
      return {
        status: 'unhealthy',
        message: error.message
      };
    }
  }

  /**
   * Check Firebase Auth
   */
  checkAuth() {
    try {
      const auth = getAuth();

      // Just check if auth is initialized
      if (auth) {
        return {
          status: 'healthy',
          message: 'Firebase Auth OK'
        };
      }

      return {
        status: 'unhealthy',
        message: 'Firebase Auth not initialized'
      };
    } catch (error) {
      logger.error('Auth health check failed', { error: error.message });
      return {
        status: 'unhealthy',
        message: error.message
      };
    }
  }

  /**
   * Check Email service
   */
  async checkEmail() {
    try {
      const transporter = getEmailTransporter();

      // Verify SMTP connection
      await transporter.verify();

      return {
        status: 'healthy',
        message: 'Email service OK'
      };
    } catch (error) {
      logger.error('Email health check failed', { error: error.message });
      return {
        status: 'unhealthy',
        message: error.message
      };
    }
  }

  /**
   * Check Scheduler status
   */
  checkScheduler() {
    // Import scheduler status (this would need to be exported from scheduler.service.js)
    // For now, we'll return a basic check
    return {
      status: 'healthy',
      message: 'Scheduler running',
      lastRun: 'N/A' // Would need to track this
    };
  }

  /**
   * Get memory usage
   */
  getMemoryUsage() {
    const usage = process.memoryUsage();
    return {
      heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)}MB`,
      heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)}MB`,
      rss: `${Math.round(usage.rss / 1024 / 1024)}MB`,
      external: `${Math.round(usage.external / 1024 / 1024)}MB`
    };
  }

  /**
   * Get last scraping status
   */
  async getLastScrapingStatus() {
    try {
      const db = getFirestore();
      const snapshot = await db
        .collection('scrapingLogs')
        .orderBy('startedAt', 'desc')
        .limit(1)
        .get();

      if (snapshot.empty) {
        return null;
      }

      const doc = snapshot.docs[0];
      const data = doc.data();

      return {
        status: data.status,
        startedAt: data.startedAt?.toDate?.() || data.startedAt,
        completedAt: data.completedAt?.toDate?.() || data.completedAt,
        itemsScraped: data.itemsScraped,
        errorMessage: data.errorMessage
      };
    } catch (error) {
      logger.error('Failed to get last scraping status', { error: error.message });
      return null;
    }
  }

  /**
   * Get system metrics
   */
  async getMetrics() {
    const db = getFirestore();

    try {
      // Get counts from collections
      const [usersCount, settingsCount, availabilityCount, notificationsCount] = await Promise.all([
        db.collection('users').count().get(),
        db.collection('userSettings').count().get(),
        db.collection('availability').count().get(),
        db.collection('notifications').count().get()
      ]);

      return {
        database: {
          users: usersCount.data().count,
          userSettings: settingsCount.data().count,
          availability: availabilityCount.data().count,
          notifications: notificationsCount.data().count
        },
        lastScraping: await this.getLastScrapingStatus()
      };
    } catch (error) {
      logger.error('Failed to get metrics', { error: error.message });
      return {
        error: error.message
      };
    }
  }
}

export const healthService = new HealthService();
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
