<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>routes/availability.routes.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="EmailError.html">EmailError</a></li><li><a href="HealthService.html">HealthService</a><ul class='methods'><li data-type='method'><a href="HealthService.html#checkAuth">checkAuth</a></li><li data-type='method'><a href="HealthService.html#checkEmail">checkEmail</a></li><li data-type='method'><a href="HealthService.html#checkFirestore">checkFirestore</a></li><li data-type='method'><a href="HealthService.html#checkHealth">checkHealth</a></li><li data-type='method'><a href="HealthService.html#checkScheduler">checkScheduler</a></li><li data-type='method'><a href="HealthService.html#getLastScrapingStatus">getLastScrapingStatus</a></li><li data-type='method'><a href="HealthService.html#getMemoryUsage">getMemoryUsage</a></li><li data-type='method'><a href="HealthService.html#getMetrics">getMetrics</a></li></ul></li><li><a href="NotificationService.html">NotificationService</a><ul class='methods'><li data-type='method'><a href="NotificationService.html#checkAndNotify">checkAndNotify</a></li><li data-type='method'><a href="NotificationService.html#hasSettingNotified">hasSettingNotified</a></li><li data-type='method'><a href="NotificationService.html#matchesCriteria">matchesCriteria</a></li><li data-type='method'><a href="NotificationService.html#sendEmailNotification">sendEmailNotification</a></li><li data-type='method'><a href="NotificationService.html#sendNotifications">sendNotifications</a></li></ul></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ScraperError.html">ScraperError</a></li><li><a href="ScraperService.html">ScraperService</a><ul class='methods'><li data-type='method'><a href="ScraperService.html#parsePage">parsePage</a></li><li data-type='method'><a href="ScraperService.html#scrapeCampingSite">scrapeCampingSite</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ERROR_CODES">ERROR_CODES</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#checkForActiveSettings">checkForActiveSettings</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#executeScraping">executeScraping</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatErrorResponse">formatErrorResponse</a></li><li><a href="global.html#formatYearMonth">formatYearMonth</a></li><li><a href="global.html#getKoreaDate">getKoreaDate</a></li><li><a href="global.html#getKoreaHour">getKoreaHour</a></li><li><a href="global.html#getMonthsFromSettings">getMonthsFromSettings</a></li><li><a href="global.html#getMonthsToScrape">getMonthsToScrape</a></li><li><a href="global.html#getRandomDelay">getRandomDelay</a></li><li><a href="global.html#isOperationalError">isOperationalError</a></li><li><a href="global.html#isRetryableError">isRetryableError</a></li><li><a href="global.html#isSleepTime">isSleepTime</a></li><li><a href="global.html#logRequestMiddleware">logRequestMiddleware</a></li><li><a href="global.html#matchesSetting">matchesSetting</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#retryIfRetryable">retryIfRetryable</a></li><li><a href="global.html#retryStrategies">retryStrategies</a></li><li><a href="global.html#retryWithBackoff">retryWithBackoff</a></li><li><a href="global.html#retryWithFixedDelay">retryWithFixedDelay</a></li><li><a href="global.html#runScrapingNow">runScrapingNow</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#startScheduler">startScheduler</a></li><li><a href="global.html#stopScheduler">stopScheduler</a></li><li><a href="global.html#validateConfig">validateConfig</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">routes/availability.routes.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import express from 'express';
import { authenticateUser } from '../middleware/auth.middleware.js';
import { firestoreService } from '../services/firestore.service.js';

const router = express.Router();

/**
 * 예약 가능 캠핑장 조회
 * @route GET /api/availability
 * @group 예약현황 - 캠핑장 예약 가능 현황 조회
 * @param {string} Authorization.header.required - Firebase ID Token (Bearer 형식)
 * @returns {Array} 200 - 사용자의 활성 설정에 매칭되는 예약 가능 현황 목록
 * @returns {Object} 401 - 인증 실패
 * @description
 * - 사용자의 활성 설정을 기반으로 예약 가능 현황 필터링
 * - 캠핑장, 지역, 구역, 날짜 범위가 일치하는 항목만 반환
 * - availableCount > 0인 항목만 포함
 * - 활성 설정이 없으면 빈 배열 반환
 */
router.get('/', authenticateUser, async (req, res, next) => {
  try {
    const userId = req.user.uid;

    // Get user's active settings
    const userSettings = await firestoreService.getUserSettings(userId);
    const activeSettings = userSettings.filter(s => s.isActive);

    if (activeSettings.length === 0) {
      // No active settings, return empty array
      return res.json({
        success: true,
        data: []
      });
    }

    // Get all availability data
    const allAvailability = await firestoreService.getAvailability({});

    // Filter based on user's active settings
    const matchedAvailability = [];
    const addedKeys = new Set(); // To avoid duplicates

    for (const setting of activeSettings) {
      for (const item of allAvailability) {
        // Skip if already added
        const key = `${item.campingName}-${item.area}-${item.date}`;
        if (addedKeys.has(key)) continue;

        // Check if item matches this setting
        if (!matchesSetting(item, setting)) continue;

        // Only include items with available count > 0
        if (item.availableCount > 0) {
          matchedAvailability.push(item);
          addedKeys.add(key);
        }
      }
    }

    res.json({
      success: true,
      data: matchedAvailability
    });
  } catch (error) {
    next(error);
  }
});

/**
 * 예약 가능 항목이 설정 조건과 일치하는지 확인하는 헬퍼 함수
 * @function
 * @param {Object} item - 예약 가능 항목
 * @param {Object} setting - 사용자 설정
 * @returns {boolean} 조건 일치 시 true
 * @description 캠핑장명, 지역, 구역(OR), 날짜 범위 조건 검증
 */
function matchesSetting(item, setting) {
  // Check camping name
  if (setting.campingName &amp;&amp; item.campingName !== setting.campingName) {
    return false;
  }

  // Check region
  if (setting.region &amp;&amp; item.region !== setting.region) {
    return false;
  }

  // Check area (if user specified specific areas)
  if (setting.area &amp;&amp; setting.area.length > 0) {
    if (!setting.area.includes(item.area)) {
      return false;
    }
  }

  // Check date range
  const itemDate = new Date(item.date);
  const dateFrom = setting.dateFrom ? new Date(setting.dateFrom) : null;
  const dateTo = setting.dateTo ? new Date(setting.dateTo) : null;

  if (dateFrom &amp;&amp; itemDate &lt; dateFrom) {
    return false;
  }

  if (dateTo &amp;&amp; itemDate > dateTo) {
    return false;
  }

  return true;
}

export default router;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
