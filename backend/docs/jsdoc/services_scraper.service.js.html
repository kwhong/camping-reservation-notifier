<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/scraper.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="EmailError.html">EmailError</a></li><li><a href="HealthService.html">HealthService</a><ul class='methods'><li data-type='method'><a href="HealthService.html#checkAuth">checkAuth</a></li><li data-type='method'><a href="HealthService.html#checkEmail">checkEmail</a></li><li data-type='method'><a href="HealthService.html#checkFirestore">checkFirestore</a></li><li data-type='method'><a href="HealthService.html#checkHealth">checkHealth</a></li><li data-type='method'><a href="HealthService.html#checkScheduler">checkScheduler</a></li><li data-type='method'><a href="HealthService.html#getLastScrapingStatus">getLastScrapingStatus</a></li><li data-type='method'><a href="HealthService.html#getMemoryUsage">getMemoryUsage</a></li><li data-type='method'><a href="HealthService.html#getMetrics">getMetrics</a></li></ul></li><li><a href="NotificationService.html">NotificationService</a><ul class='methods'><li data-type='method'><a href="NotificationService.html#checkAndNotify">checkAndNotify</a></li><li data-type='method'><a href="NotificationService.html#hasSettingNotified">hasSettingNotified</a></li><li data-type='method'><a href="NotificationService.html#matchesCriteria">matchesCriteria</a></li><li data-type='method'><a href="NotificationService.html#sendEmailNotification">sendEmailNotification</a></li><li data-type='method'><a href="NotificationService.html#sendNotifications">sendNotifications</a></li></ul></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ScraperError.html">ScraperError</a></li><li><a href="ScraperService.html">ScraperService</a><ul class='methods'><li data-type='method'><a href="ScraperService.html#parsePage">parsePage</a></li><li data-type='method'><a href="ScraperService.html#scrapeCampingSite">scrapeCampingSite</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ERROR_CODES">ERROR_CODES</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#checkForActiveSettings">checkForActiveSettings</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#executeScraping">executeScraping</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatErrorResponse">formatErrorResponse</a></li><li><a href="global.html#formatYearMonth">formatYearMonth</a></li><li><a href="global.html#getKoreaDate">getKoreaDate</a></li><li><a href="global.html#getKoreaHour">getKoreaHour</a></li><li><a href="global.html#getMonthsFromSettings">getMonthsFromSettings</a></li><li><a href="global.html#getMonthsToScrape">getMonthsToScrape</a></li><li><a href="global.html#getRandomDelay">getRandomDelay</a></li><li><a href="global.html#isOperationalError">isOperationalError</a></li><li><a href="global.html#isRetryableError">isRetryableError</a></li><li><a href="global.html#isSleepTime">isSleepTime</a></li><li><a href="global.html#logRequestMiddleware">logRequestMiddleware</a></li><li><a href="global.html#matchesSetting">matchesSetting</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#retryIfRetryable">retryIfRetryable</a></li><li><a href="global.html#retryStrategies">retryStrategies</a></li><li><a href="global.html#retryWithBackoff">retryWithBackoff</a></li><li><a href="global.html#retryWithFixedDelay">retryWithFixedDelay</a></li><li><a href="global.html#runScrapingNow">runScrapingNow</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#startScheduler">startScheduler</a></li><li><a href="global.html#stopScheduler">stopScheduler</a></li><li><a href="global.html#validateConfig">validateConfig</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/scraper.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { chromium } from 'playwright';
import { logger } from '../utils/logger.js';
import { getMonthsToScrape, getMonthsFromSettings } from '../utils/date.js';
import { firestoreService } from './firestore.service.js';

const BASE_URL = 'https://mirihae.com/camping/calendar.do';
const BASE_PARAMS =
  'checkType=&amp;device=pc&amp;tocken=20251009233437-4cb6fa5d-17f6-471d-8830-3b10d580e648&amp;pageId=G24526799&amp;groupCode=dytc&amp;selectStartDate=&amp;selectEndDate=&amp;selectItemId=&amp;selectTicketId=&amp;cnt=&amp;infoType=&amp;approvalId=&amp;txId=';

const CAMPING_INFO = {
  name: 'ë‹¤ë¦¬ì•ˆê³„ê³¡ìº í•‘ìž¥',
  region: 'ì¶©ë¶ ë‹¨ì–‘'
};

/**
 * ìº í•‘ìž¥ ìŠ¤í¬ëž˜í•‘ ì„œë¹„ìŠ¤
 * @class
 * @description Playwrightë¥¼ ì‚¬ìš©í•˜ì—¬ ìº í•‘ìž¥ ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©ì„ ìŠ¤í¬ëž˜í•‘í•˜ëŠ” ì„œë¹„ìŠ¤
 */
export class ScraperService {
  /**
   * ìº í•‘ìž¥ ì˜ˆì•½ ê°€ëŠ¥ í˜„í™© ìŠ¤í¬ëž˜í•‘
   * @async
   * @param {Array} activeSettings - í™œì„±í™”ëœ ì‚¬ìš©ìž ì„¤ì • ëª©ë¡ (ìŠ¤í¬ëž˜í•‘í•  ì›” ê²°ì •ì— ì‚¬ìš©)
   * @returns {Promise&lt;number>} ìŠ¤í¬ëž˜í•‘ëœ í•­ëª© ìˆ˜
   * @throws {Error} ë¸Œë¼ìš°ì € ì‹¤í–‰ ë˜ëŠ” ìŠ¤í¬ëž˜í•‘ ì‹¤íŒ¨ ì‹œ
   * @description
   * - Chromium í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €ë¡œ ìº í•‘ ì‚¬ì´íŠ¸ ì ‘ì†
   * - í™œì„± ì„¤ì •ì˜ ë‚ ì§œ ë²”ìœ„ì—ì„œ ì›” ì¶”ì¶œ, ì—†ìœ¼ë©´ ê¸°ë³¸ 3ê°œì›” ìŠ¤í¬ëž˜í•‘
   * - ê° ì›”ë³„ íŽ˜ì´ì§€ë¥¼ íŒŒì‹±í•˜ì—¬ ì˜ˆì•½ ê°€ëŠ¥ ë°ì´í„° ìˆ˜ì§‘
   * - Firestoreì— ì¼ê´„ ì €ìž¥ ë° ìŠ¤í¬ëž˜í•‘ ë¡œê·¸ ê¸°ë¡
   */
  async scrapeCampingSite(activeSettings = []) {
    const logId = await firestoreService.createScrapingLog({
      status: 'running',
      itemsScraped: 0
    });

    let browser;
    let totalItemsScraped = 0;

    try {
      logger.info('ðŸ” Starting camping site scraping...');

      // Launch browser with timeout
      browser = await chromium.launch({
        headless: true,
        timeout: 30000 // 30 second launch timeout
      });

      const context = await browser.newContext();
      const page = await context.newPage();

      // Set page timeout
      page.setDefaultTimeout(30000); // 30 seconds for page operations

      // Get months from active settings, or fall back to default 3 months
      let months = [];
      if (activeSettings.length > 0) {
        months = getMonthsFromSettings(activeSettings);
        if (months.length === 0) {
          // If no valid dates in settings, use default
          months = getMonthsToScrape();
          logger.info('No valid dates in settings, using default months');
        } else {
          logger.info(`Scraping months from active settings: ${months.join(', ')}`);
        }
      } else {
        months = getMonthsToScrape();
        logger.info(`No active settings, using default months: ${months.join(', ')}`);
      }

      // Collect all data first
      const allAvailabilityData = [];

      for (const month of months) {
        logger.info(`Scraping month: ${month}`);
        const url = `${BASE_URL}?${BASE_PARAMS}&amp;selectMonth=${month}`;

        await page.goto(url, { waitUntil: 'networkidle' });
        await page.waitForTimeout(2000); // Wait for dynamic content

        // Parse the page
        const availabilityData = await this.parsePage(page, month);
        totalItemsScraped += availabilityData.length;

        // Add camping info and collect
        const dataWithInfo = availabilityData.map(item => ({
          ...item,
          campingName: CAMPING_INFO.name,
          region: CAMPING_INFO.region
        }));

        allAvailabilityData.push(...dataWithInfo);

        logger.info(`Scraped ${availabilityData.length} items for ${month}`);
      }

      // Batch save all data at once (more efficient)
      if (allAvailabilityData.length > 0) {
        logger.info(`Saving ${allAvailabilityData.length} items to Firestore...`);
        await firestoreService.batchSaveAvailability(allAvailabilityData);
        logger.info('âœ… All data saved successfully');
      }

      logger.info(`âœ… Scraping completed successfully. Total items: ${totalItemsScraped}`);

      await firestoreService.updateScrapingLog(logId, {
        status: 'success',
        itemsScraped: totalItemsScraped
      });

      return totalItemsScraped;
    } catch (error) {
      logger.error('âŒ Scraping error:', error);

      await firestoreService
        .updateScrapingLog(logId, {
          status: 'error',
          errorMessage: error.message,
          itemsScraped: totalItemsScraped
        })
        .catch(err => logger.error('Failed to update scraping log:', err));

      throw error;
    } finally {
      // Ensure browser is always closed
      if (browser) {
        try {
          await browser.close();
          logger.debug('Browser closed successfully');
        } catch (closeError) {
          logger.error('Error closing browser:', closeError);
          // Force kill browser process if close fails
          try {
            await browser.process()?.kill('SIGKILL');
            logger.warn('Browser process force killed');
          } catch (killError) {
            logger.error('Failed to kill browser process:', killError);
          }
        }
      }
    }
  }

  /**
   * íŽ˜ì´ì§€ íŒŒì‹±í•˜ì—¬ ì˜ˆì•½ ê°€ëŠ¥ ë°ì´í„° ì¶”ì¶œ
   * @async
   * @param {Page} page - Playwright íŽ˜ì´ì§€ ê°ì²´
   * @param {string} _month - ìŠ¤í¬ëž˜í•‘ ëŒ€ìƒ ì›” (YYYY-MM, ë¡œê¹… ìš©ë„)
   * @returns {Promise&lt;Array>} ì˜ˆì•½ ê°€ëŠ¥ ë°ì´í„° ë°°ì—´
   * @description
   * - HTML êµ¬ì¡°: &lt;div id="YYYY-MM-DD"> ë‚´ë¶€ì˜ &lt;dl class="schedule"> íŒŒì‹±
   * - ê° dl ìš”ì†Œì—ì„œ êµ¬ì—­ëª…(dd)ê³¼ ì˜ˆì•½ ê°€ëŠ¥ ìˆ˜(dt) ì¶”ì¶œ
   * - ë‚ ì§œë³„, êµ¬ì—­ë³„ ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©ì„ ë°°ì—´ë¡œ ë°˜í™˜
   */
  async parsePage(page, _month) {
    const availabilityData = [];

    try {
      // Get all date divs - structure: &lt;div id="YYYY-MM-DD">
      const datePattern = /^\d{4}-\d{2}-\d{2}$/;

      // Get all divs and filter by date pattern in ID
      const allDivs = await page.$$('div[id]');

      for (const dateDiv of allDivs) {
        const dateId = await dateDiv.getAttribute('id');

        // Check if ID matches date pattern (YYYY-MM-DD)
        if (!dateId || !datePattern.test(dateId)) continue;

        const fullDate = dateId;
        logger.debug(`Processing date: ${fullDate}`);

        // Within each date div, find all &lt;dl class="schedule"> elements
        // Structure: &lt;div class="element"> > &lt;div class="district"> > &lt;dl class="schedule">
        const dlElements = await dateDiv.$$('dl.schedule');

        for (const dl of dlElements) {
          // Get availability count from &lt;dt> tag
          const dtElement = await dl.$('dt');
          if (!dtElement) continue;

          const countText = await dtElement.textContent();
          const availableCount = parseInt(countText?.trim() || '0');

          // Get area name from &lt;dd> tag
          const ddElement = await dl.$('dd');
          if (!ddElement) continue;

          const areaName = await ddElement.textContent();
          if (!areaName) continue;

          availabilityData.push({
            area: areaName.trim(),
            date: fullDate,
            availableCount: availableCount
          });

          logger.debug(`  Area: ${areaName.trim()}, Available: ${availableCount}`);
        }
      }

      return availabilityData;
    } catch (error) {
      logger.error('Error parsing page:', error);
      throw error;
    }
  }
}

export const scraperService = new ScraperService();
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
