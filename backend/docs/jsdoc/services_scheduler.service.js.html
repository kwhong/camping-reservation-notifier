<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/scheduler.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="EmailError.html">EmailError</a></li><li><a href="HealthService.html">HealthService</a><ul class='methods'><li data-type='method'><a href="HealthService.html#checkAuth">checkAuth</a></li><li data-type='method'><a href="HealthService.html#checkEmail">checkEmail</a></li><li data-type='method'><a href="HealthService.html#checkFirestore">checkFirestore</a></li><li data-type='method'><a href="HealthService.html#checkHealth">checkHealth</a></li><li data-type='method'><a href="HealthService.html#checkScheduler">checkScheduler</a></li><li data-type='method'><a href="HealthService.html#getLastScrapingStatus">getLastScrapingStatus</a></li><li data-type='method'><a href="HealthService.html#getMemoryUsage">getMemoryUsage</a></li><li data-type='method'><a href="HealthService.html#getMetrics">getMetrics</a></li></ul></li><li><a href="NotificationService.html">NotificationService</a><ul class='methods'><li data-type='method'><a href="NotificationService.html#checkAndNotify">checkAndNotify</a></li><li data-type='method'><a href="NotificationService.html#hasSettingNotified">hasSettingNotified</a></li><li data-type='method'><a href="NotificationService.html#matchesCriteria">matchesCriteria</a></li><li data-type='method'><a href="NotificationService.html#sendEmailNotification">sendEmailNotification</a></li><li data-type='method'><a href="NotificationService.html#sendNotifications">sendNotifications</a></li></ul></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ScraperError.html">ScraperError</a></li><li><a href="ScraperService.html">ScraperService</a><ul class='methods'><li data-type='method'><a href="ScraperService.html#parsePage">parsePage</a></li><li data-type='method'><a href="ScraperService.html#scrapeCampingSite">scrapeCampingSite</a></li></ul></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ERROR_CODES">ERROR_CODES</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#checkForActiveSettings">checkForActiveSettings</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#executeScraping">executeScraping</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatErrorResponse">formatErrorResponse</a></li><li><a href="global.html#formatYearMonth">formatYearMonth</a></li><li><a href="global.html#getKoreaDate">getKoreaDate</a></li><li><a href="global.html#getKoreaHour">getKoreaHour</a></li><li><a href="global.html#getMonthsFromSettings">getMonthsFromSettings</a></li><li><a href="global.html#getMonthsToScrape">getMonthsToScrape</a></li><li><a href="global.html#getRandomDelay">getRandomDelay</a></li><li><a href="global.html#isOperationalError">isOperationalError</a></li><li><a href="global.html#isRetryableError">isRetryableError</a></li><li><a href="global.html#isSleepTime">isSleepTime</a></li><li><a href="global.html#logRequestMiddleware">logRequestMiddleware</a></li><li><a href="global.html#matchesSetting">matchesSetting</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#retryIfRetryable">retryIfRetryable</a></li><li><a href="global.html#retryStrategies">retryStrategies</a></li><li><a href="global.html#retryWithBackoff">retryWithBackoff</a></li><li><a href="global.html#retryWithFixedDelay">retryWithFixedDelay</a></li><li><a href="global.html#runScrapingNow">runScrapingNow</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#startScheduler">startScheduler</a></li><li><a href="global.html#stopScheduler">stopScheduler</a></li><li><a href="global.html#validateConfig">validateConfig</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/scheduler.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import cron from 'node-cron';
import { logger } from '../utils/logger.js';
import { isSleepTime, getRandomDelay, getKoreaDate } from '../utils/date.js';
import { scraperService } from './scraper.service.js';
import { notificationService } from './notification.service.js';
import { firestoreService } from './firestore.service.js';

let schedulerTask = null;

/**
 * Ïä§ÏºÄÏ§ÑÎü¨ ÏãúÏûë
 * @function
 * @description
 * - 10Î∂ÑÎßàÎã§ Ïã§ÌñâÎêòÎäî Cron ÏûëÏóÖ Îì±Î°ù
 * - Ïã§Ìñâ Ï†Ñ 30-120Ï¥à ÎûúÎç§ ÎîúÎ†àÏù¥ Ï∂îÍ∞Ä (ÏÑúÎ≤Ñ Î∂ÄÌïò Î∂ÑÏÇ∞)
 * - ÏàòÎ©¥ ÏãúÍ∞Ñ(01:00-08:00 KST) Ï≤¥ÌÅ¨ÌïòÏó¨ Ïä§ÌÇµ
 * - ÌôúÏÑ± ÏÑ§Ï†ïÏù¥ ÏûàÍ≥† ÎØ∏Îûò ÎÇ†ÏßúÍ∞Ä ÏûàÏùÑ ÎïåÎßå Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìñâ
 */
export const startScheduler = () => {
  if (schedulerTask) {
    logger.warn('Scheduler is already running');
    return;
  }

  // Run every 10 minutes
  schedulerTask = cron.schedule('*/10 * * * *', async () => {
    try {
      // Add random delay (30-120 seconds)
      const delay = getRandomDelay(30, 120);
      logger.info(`‚è∞ Scheduler triggered. Waiting ${delay / 1000}s before execution...`);

      await new Promise(resolve => setTimeout(resolve, delay));

      // Check if it's sleep time (01:00 - 08:00 KST)
      if (isSleepTime()) {
        logger.info('üò¥ Sleep time (01:00-08:00 KST). Skipping scraping.');
        return;
      }

      // Check if there are any active user settings with future dates
      const hasActiveSettings = await checkForActiveSettings();

      if (!hasActiveSettings) {
        logger.info('‚è≠Ô∏è No active user settings with future dates. Skipping scraping.');
        return;
      }

      // Execute scraping
      logger.info('üöÄ Starting scheduled scraping...');
      await executeScraping();
    } catch (error) {
      logger.error('‚ùå Scheduler error:', error);
    }
  });

  logger.info(
    '‚úÖ Scheduler started successfully (runs every 10 minutes with 30-120s random delay)'
  );
};

/**
 * Ïä§ÏºÄÏ§ÑÎü¨ Ï§ëÏßÄ
 * @function
 * @description Ïã§Ìñâ Ï§ëÏù∏ Cron ÏûëÏóÖÏùÑ Ï§ëÏßÄÌïòÍ≥† nullÎ°ú Ï¥àÍ∏∞Ìôî
 */
export const stopScheduler = () => {
  if (schedulerTask) {
    schedulerTask.stop();
    schedulerTask = null;
    logger.info('‚èπÔ∏è Scheduler stopped');
  }
};

/**
 * ÌôúÏÑ± ÏÑ§Ï†ï Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
 * @async
 * @function
 * @returns {Promise&lt;boolean>} ÎØ∏Îûò ÎÇ†ÏßúÎ•º Ìè¨Ìï®Ìïú ÌôúÏÑ± ÏÑ§Ï†ïÏù¥ ÏûàÏúºÎ©¥ true
 * @description
 * - Î™®Îì† ÌôúÏÑ± ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ï°∞Ìöå
 * - Í∞Å ÏÑ§Ï†ïÏùò dateFrom ÎòêÎäî dateToÍ∞Ä Ïò§Îäò Ïù¥ÌõÑÏù∏ÏßÄ ÌôïÏù∏
 * - ÎÇ†ÏßúÍ∞Ä ÏßÄÏ†ïÎêòÏßÄ ÏïäÏùÄ ÏÑ§Ï†ïÎèÑ ÌôúÏÑ±ÏúºÎ°ú Í∞ÑÏ£º
 */
async function checkForActiveSettings() {
  try {
    const activeSettings = await firestoreService.getAllActiveSettings();

    if (activeSettings.length === 0) {
      return false;
    }

    // Check if any setting has a future date
    const today = getKoreaDate();
    today.setHours(0, 0, 0, 0);

    const hasFutureDates = activeSettings.some(setting => {
      const dateFrom = setting.dateFrom ? new Date(setting.dateFrom) : null;
      const dateTo = setting.dateTo ? new Date(setting.dateTo) : null;

      // If no dates specified, consider it as active
      if (!dateFrom &amp;&amp; !dateTo) return true;

      // If dateTo exists and is in the future
      if (dateTo &amp;&amp; dateTo >= today) return true;

      // If only dateFrom exists and is in the future
      if (dateFrom &amp;&amp; !dateTo &amp;&amp; dateFrom >= today) return true;

      return false;
    });

    return hasFutureDates;
  } catch (error) {
    logger.error('Error checking active settings:', error);
    return false;
  }
}

/**
 * Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìñâ Î∞è ÏïåÎ¶º Ï≤¥ÌÅ¨
 * @async
 * @function
 * @returns {Promise&lt;void>}
 * @throws {Error} Ïä§ÌÅ¨ÎûòÌïë ÎòêÎäî ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå® Ïãú
 * @description
 * - ÌôúÏÑ± ÏÑ§Ï†ï Í∏∞Î∞òÏúºÎ°ú Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìñâ
 * - Ïä§ÌÅ¨ÎûòÌïëÎêú Ìï≠Î™© Ïàò Î°úÍπÖ
 * - ÏµúÏã† ÏòàÏïΩ Í∞ÄÎä• ÌòÑÌô© Ï°∞Ìöå
 * - ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ïÍ≥º Îß§Ïπ≠ÌïòÏó¨ ÏïåÎ¶º Î∞úÏÜ°
 */
async function executeScraping() {
  try {
    // Get all active settings to determine which months to scrape
    const activeSettings = await firestoreService.getAllActiveSettings();

    // Run the scraper with active settings
    const itemsScraped = await scraperService.scrapeCampingSite(activeSettings);

    if (itemsScraped > 0) {
      logger.info(`‚úÖ Scraping completed: ${itemsScraped} items scraped`);

      // Get latest availability data to check for notifications
      const latestAvailability = await firestoreService.getAvailability({ limit: 100 });

      // Check if we need to send any notifications
      await notificationService.checkAndNotify(latestAvailability);
    } else {
      logger.warn('‚ö†Ô∏è No items scraped');
    }
  } catch (error) {
    logger.error('Error executing scraping:', error);
    throw error;
  }
}

/**
 * ÏàòÎèô Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìñâ (ÌÖåÏä§Ìä∏Ïö©)
 * @async
 * @function
 * @returns {Promise&lt;void>}
 * @description Ïä§ÏºÄÏ§ÑÎü¨ ÎåÄÍ∏∞ ÏóÜÏù¥ Ï¶âÏãú Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìñâ (Í∞úÎ∞ú/ÌÖåÏä§Ìä∏ Ïö©ÎèÑ)
 */
export const runScrapingNow = async () => {
  logger.info('üîß Manual scraping triggered');
  await executeScraping();
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
